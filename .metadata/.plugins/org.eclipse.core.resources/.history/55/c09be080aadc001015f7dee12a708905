package com.example.demo.service;

import java.util.*;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.stereotype.Component;
import org.springframework.web.client.RestTemplate;

@Component
public class GeminiClient {
  private final RestTemplate rest = new RestTemplate();

  @Value("${gemini.api.key}")
  private String apiKey;

  @Value("${gemini.model:gemini-1.5-flash}")
  private String model;

  public String generate(String prompt) {
    String url = "https://generativelanguage.googleapis.com/v1beta/models/"
        + model + ":generateContent?key=" + apiKey;

    Map<String,Object> body = Map.of(
      "contents", List.of(
        Map.of("role","user","parts", List.of(Map.of("text", prompt)))
      ),
      "generationConfig", Map.of(
        "temperature", 0.4,
        "maxOutputTokens", 500
      )
    );

    HttpHeaders headers = new HttpHeaders();
    headers.setContentType(MediaType.APPLICATION_JSON);

    ResponseEntity<Map> res = rest.postForEntity(url, new HttpEntity<>(body, headers), Map.class);

    if (!res.getStatusCode().is2xxSuccessful() || res.getBody() == null) {
      throw new RuntimeException("GEMINI_CALL_FAILED");
    }

    try {
      List<Map<String,Object>> candidates = (List<Map<String,Object>>) res.getBody().get("candidates");
      Map<String,Object> c0 = candidates.get(0);
      Map<String,Object> content = (Map<String,Object>) c0.get("content");
      List<Map<String,Object>> parts = (List<Map<String,Object>>) content.get("parts");
      return String.valueOf(parts.get(0).get("text"));
    } catch (Exception e) {
      throw new RuntimeException("GEMINI_PARSE_FAILED: " + e.getMessage());
    }
  }
}
