package com.example.demo.repository;

import java.util.List;
import java.util.Map;
import java.util.Optional;

import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Repository;

@Repository
public class ProductDetailRepository {

    private final JdbcTemplate jdbc;

    public ProductDetailRepository(JdbcTemplate jdbc) {
        this.jdbc = jdbc;
    }

    public Optional<Map<String, Object>> findProductBySlug(String slug) {
        String sql = """
            SELECT product_id, category_id, name, slug, sku, base_price,
                   description, main_image, created_at
            FROM products
            WHERE slug = ? AND is_active = 1
            LIMIT 1
        """;

        List<Map<String, Object>> rows = jdbc.queryForList(sql, slug);
        if (rows.isEmpty()) return Optional.empty();
        return Optional.of(rows.get(0));
    }

    public List<String> findGallery(long productId) {
        return jdbc.queryForList(
            "SELECT image_url FROM product_images WHERE product_id = ? ORDER BY display_order",
            String.class,
            productId
        );
    }

    // ✅ FIX: size_label -> size (và lấy thêm color nếu có)
    public List<Map<String, Object>> findVariants(long productId) {
        return jdbc.queryForList("""
            SELECT material, size, price
            FROM product_variants
            WHERE product_id = ? AND is_active = 1
            ORDER BY variant_id ASC
        """, productId);
    }

    // ✅ lấy màu distinct nếu DB có cột color
    // Nếu DB bạn chưa có cột color thì query này sẽ lỗi -> bạn có thể comment hàm này hoặc sửa theo DB
    public List<String> findDistinctColors(long productId) {
        // Nếu bảng product_variants KHÔNG có cột color => đổi thành: SELECT DISTINCT material ... hoặc return List.of()
        // Mình để sẵn theo hướng "có color", bạn check DB nhé.
        try {
            return jdbc.queryForList("""
                SELECT DISTINCT color
                FROM product_variants
                WHERE product_id = ? AND is_active = 1 AND color IS NOT NULL AND color <> ''
                ORDER BY color ASC
            """, String.class, productId);
        } catch (Exception ex) {
            // fallback nếu DB không có cột color
            return List.of();
        }
    }

    public List<Map<String, Object>> findRelated(long categoryId, long productId) {
        return jdbc.queryForList("""
            SELECT product_id, name, slug, base_price, main_image
            FROM products
            WHERE category_id = ?
              AND product_id <> ?
              AND is_active = 1
            ORDER BY created_at DESC, product_id DESC
            LIMIT 4
        """, categoryId, productId);
    }
}
