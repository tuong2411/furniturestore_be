package com.example.demo.service;

import java.math.BigDecimal;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.NoSuchElementException;

import org.springframework.stereotype.Service;

import com.example.demo.dto.ProductDetailDto;
import com.example.demo.repository.ProductDetailRepository;

@Service
public class ProductDetailService {

    private final ProductDetailRepository repo;

    public ProductDetailService(ProductDetailRepository repo) {
        this.repo = repo;
    }

    public ProductDetailDto getBySlug(String slug) {
        Map<String, Object> p = repo.findProductBySlug(slug)
                .orElseThrow(() -> new NoSuchElementException("PRODUCT_NOT_FOUND"));

        long productId = ((Number) p.get("product_id")).longValue();
        long categoryId = ((Number) p.get("category_id")).longValue();

        ProductDetailDto dto = new ProductDetailDto();
        dto.id = productId;
        dto.name = (String) p.get("name");
        dto.slug = (String) p.get("slug");
        dto.sku = (String) p.get("sku");
        dto.price = (BigDecimal) p.get("base_price");
        dto.originalPrice = null; // DB chưa có original_price thì để null
        dto.mainImage = (String) p.get("main_image");
        dto.description = (String) p.get("description");

        // tạm hardcode (sau nối review)
        dto.rating = 4.8;
        dto.reviewCount = 125;

        // gallery
        dto.gallery = repo.findGallery(productId);

        // Variants
        List<Map<String, Object>> vars = repo.findVariants(productId);

        ProductDetailDto.VariantDto vdto = new ProductDetailDto.VariantDto();

        // ✅ Colors: DB bạn có thể chỉ lưu color string => map demo về hex
        // Nếu DB có cột color thì lấy distinct; không có thì fallback demo như bạn đang làm
        List<ProductDetailDto.ColorDto> colors = repo.findDistinctColors(productId).stream().map(colorName -> {
            ProductDetailDto.ColorDto c = new ProductDetailDto.ColorDto();
            c.name = colorName;
            c.hex = mapColorToHex(colorName);
            return c;
        }).toList();

        if (colors.isEmpty()) {
            ProductDetailDto.ColorDto c = new ProductDetailDto.ColorDto();
            c.name = "Trắng kem";
            c.hex = "#F5F5DC";
            vdto.colors = List.of(c);
        } else {
            vdto.colors = colors;
        }

        // ✅ Sizes: gom theo size để FE không bị lặp (mỗi size 1 dòng)
        // lấy giá thấp nhất cho mỗi size (ổn nhất khi có nhiều variant)
        Map<String, BigDecimal> sizeToMinPrice = new LinkedHashMap<>();
        for (Map<String, Object> r : vars) {
            String size = (String) r.get("size"); // ✅ đổi size_label -> size
            BigDecimal price = (BigDecimal) r.get("price");

            if (size == null || size.isBlank()) size = "Tiêu chuẩn";
            if (price == null) price = dto.price != null ? dto.price : BigDecimal.ZERO;

            sizeToMinPrice.merge(size, price, (oldV, newV) -> oldV.min(newV));
        }

        vdto.sizes = sizeToMinPrice.entrySet().stream().map(e -> {
            ProductDetailDto.SizeDto s = new ProductDetailDto.SizeDto();
            s.label = e.getKey();
            s.price = e.getValue();
            return s;
        }).toList();

        dto.variants = vdto;

        // specs (tạm hardcode)
        dto.specs = Map.of(
                "Chất liệu bọc", "Vải Bouclé",
                "Khung", "Gỗ sồi tự nhiên",
                "Đệm", "Mút D40 + lò xo túi",
                "Chân ghế", "Gỗ sồi sơn mờ"
        );

        // ✅ related theo đúng categoryId của sản phẩm
        dto.relatedProducts = repo.findRelated(categoryId, productId).stream().map(r -> {
            ProductDetailDto.RelatedProductDto rp = new ProductDetailDto.RelatedProductDto();
            rp.id = ((Number) r.get("product_id")).longValue();
            rp.name = (String) r.get("name");
            rp.slug = (String) r.get("slug");
            rp.price = (BigDecimal) r.get("base_price");
            rp.image = (String) r.get("main_image");
            return rp;
        }).toList();

        return dto;
    }

    // map demo màu -> hex (bạn muốn chuẩn thì làm bảng colors sau)
    private String mapColorToHex(String name) {
        if (name == null) return "#F5F5DC";
        String n = name.trim().toLowerCase();
        if (n.contains("trắng")) return "#F5F5DC";
        if (n.contains("kem")) return "#F5F5DC";
        if (n.contains("nâu")) return "#D2B48C";
        if (n.contains("xám") || n.contains("ghi")) return "#808080";
        if (n.contains("đen")) return "#111827";
        if (n.contains("xanh")) return "#3B82F6";
        if (n.contains("đỏ")) return "#EF4444";
        return "#9CA3AF";
    }
}
