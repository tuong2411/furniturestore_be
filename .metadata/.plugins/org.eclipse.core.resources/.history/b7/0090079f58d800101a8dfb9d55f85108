package com.example.demo.service;

import java.math.BigDecimal;
import java.util.List;
import java.util.Map;

import org.springframework.stereotype.Service;

import com.example.demo.dto.ProductDetailDto;
import com.example.demo.repository.ProductDetailRepository;

@Service
public class ProductDetailService {
	private final ProductDetailRepository repo;

    public ProductDetailService(ProductDetailRepository repo) {
        this.repo = repo;
    }

    public ProductDetailDto getBySlug(String slug) {
        Map<String, Object> p = repo.findProductBySlug(slug);
        long productId = ((Number) p.get("product_id")).longValue();

        ProductDetailDto dto = new ProductDetailDto();
        dto.id = productId;
        dto.name = (String) p.get("name");
        dto.slug = (String) p.get("slug");
        dto.sku = (String) p.get("sku");
        dto.price = (BigDecimal) p.get("base_price");
        dto.originalPrice = (BigDecimal) p.get("original_price");
        dto.mainImage = (String) p.get("main_image");
        dto.description = (String) p.get("description");

        dto.rating = 4.8;          // tạm hardcode (sau nối review)
        dto.reviewCount = 125;     // tạm hardcode

        dto.gallery = repo.findGallery(productId);

        // Variants
        List<Map<String, Object>> vars = repo.findVariants(productId);
        ProductDetailDto.VariantDto vdto = new ProductDetailDto.VariantDto();

        vdto.colors = List.of(
            Map.of("name", "Trắng kem", "hex", "#F5F5DC")
        ).stream().map(m -> {
            ProductDetailDto.ColorDto c = new ProductDetailDto.ColorDto();
            c.name = (String) m.get("name");
            c.hex = (String) m.get("hex");
            return c;
        }).toList();

        vdto.sizes = vars.stream().map(r -> {
            ProductDetailDto.SizeDto s = new ProductDetailDto.SizeDto();
            s.label = (String) r.get("size_label");
            s.price = (BigDecimal) r.get("price");
            return s;
        }).toList();

        dto.variants = vdto;

        dto.specs = Map.of(
            "Chất liệu bọc", "Vải Bouclé",
            "Khung", "Gỗ sồi tự nhiên",
            "Đệm", "Mút D40 + lò xo túi",
            "Chân ghế", "Gỗ sồi sơn mờ"
        );

        long categoryId = 1;
        dto.relatedProducts = repo.findRelated(categoryId, productId).stream().map(r -> {
            ProductDetailDto.RelatedProductDto rp = new ProductDetailDto.RelatedProductDto();
            rp.id = ((Number) r.get("product_id")).longValue();
            rp.name = (String) r.get("name");
            rp.slug = (String) r.get("slug");
            rp.price = (BigDecimal) r.get("base_price");
            rp.image = (String) r.get("main_image");
            return rp;
        }).toList();

        return dto;
    }

}
